<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雅思词汇助手 - 智能学习</title>

    <!-- PWA 支持 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="雅思词汇">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="description" content="智能雅思词汇学习应用，助你高效备考IELTS">

    <style>
        :root {
            /* 更有质感的配色方案 - 现代学术风 */
            --primary: #0f172a;
            /* 深邃午夜蓝 */
            --primary-gradient: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            /* 哑光质感渐变 */
            --background: #fdfcf8;
            /* 暖调纸张白，护眼且高级 */
            --surface: #ffffff;
            --surface-hover: #f8fafc;

            --text-main: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;

            /* 也是用更有质感的辅助色 */
            --success: #059669;
            /* 翡翠绿 */
            --error: #be123c;
            /* 胭脂红 */
            --warning: #b45309;
            /* 琥珀金 */

            /* 更克制的阴影，类似一种纸张的层叠感 */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.06), 0 4px 6px -2px rgba(0, 0, 0, 0.03);

            --radius-md: 8px;
            /* 减小圆角，显得更干练 */
            --radius-lg: 16px;
            --radius-xl: 24px;

            --font-serif: "Georgia", "Times New Roman", "Songti SC", "STSong", "SimSun", serif;
            --font-sans: system-ui, -apple-system, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans SC", "Helvetica Neue", Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--background);
            /* 去掉花哨的径向渐变，改用纯净/微纹理背景 */
            background-image: none;
            min-height: 100vh;
            color: var(--text-main);
            letter-spacing: -0.01em;
            /* 现代排版紧凑感 */
        }

        h1,
        h2,
        h3,
        .card-title,
        .word-text,
        .nav-brand {
            font-family: var(--font-serif);
            /* 标题使用衬线体 */
            letter-spacing: -0.02em;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100vh;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: transparent;
            /* 去掉背景盒子 */
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            /* 去掉阴影 */
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 10px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
        }

        /* 选中状态改为底部线条指示，更高级 */
        .nav-tab.active {
            color: var(--primary);
            background: transparent;
            box-shadow: none;
            font-weight: 600;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            /* 对齐边框 */
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .nav-tab:hover:not(.active) {
            color: var(--text-main);
            background: transparent;
        }

        /* 移动端底部导航优化 */
        @media (max-width: 600px) {
            body {
                padding-bottom: 80px;
                /* 为底部导航留出空间 */
            }

            .app-container {
                padding: 12px;
                min-height: auto;
            }

            .nav-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                padding: 8px 6px 24px 6px;
                /* 适配全面屏底部横条 */
                border-radius: 20px 20px 0 0;
                /* 仅顶部圆角 */
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                z-index: 1000;
                gap: 4px;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            }

            .nav-tab {
                flex-direction: column;
                padding: 6px 2px;
                gap: 2px;
                font-size: 10px;
                background: transparent !important;
                /* 移动端移除背景块 */
                color: #9ca3af;
                border-radius: 8px;
            }

            .nav-tab span:first-child {
                font-size: 20px;
                margin-bottom: 2px;
            }

            .nav-tab.active {
                color: var(--primary);
                background: transparent !important;
                box-shadow: none;
            }

            .nav-tab.active span:first-child {
                transform: translateY(-2px);
                transition: transform 0.2s;
            }
        }

        /* Page Container */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            /* 极简阴影 */
            border: 1px solid rgba(0, 0, 0, 0.04);
            /* 微边框 */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        /* Task Cards */
        .task-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .task-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(0, 0, 0, 0.08);
        }

        /* 优雅的状态标识，不再使用粗边框 */
        .task-card.review {
            background: linear-gradient(180deg, #fff 0%, #fffbf0 100%);
        }

        .task-card.learn {
            background: linear-gradient(180deg, #fff 0%, #f0fdf4 100%);
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .task-card.review {
            border-color: var(--warning);
        }

        .task-card.learn {
            border-color: var(--success);
        }

        .task-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .task-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .task-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .task-count {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .task-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Main Nav & Brand */
        .main-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-brand {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.03em;
            font-family: var(--font-serif);
        }

        /* Category Selector */
        .category-section {
            margin-bottom: 24px;
        }

        .category-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-selector {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            /* 移除默认样式，建议配合自定义箭头背景 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .category-selector:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.05);
            /* 使用更淡的阴影 */
        }

        .category-info {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-muted);
            font-style: italic;
            /* 增加一点风味 */
        }

        .category-count {
            font-weight: 600;
            color: var(--primary);
        }

        /* Today Stats */
        .today-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .today-stat {
            text-align: center;
            padding: 16px 8px;
            background: rgba(248, 250, 252, 0.8);
            /* 极简背景 */
            border-radius: var(--radius-md);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .today-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .today-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        /* Learning Mode */
        .learning-container {
            display: none;
        }

        .learning-container.active {
            display: block;
        }

        .mode-badge {
            display: inline-block;
            padding: 6px 12px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .mode-badge.learn-mode {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .progress-bar-container {
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        /* Word Card */
        .word-card {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }

        .word-text {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .word-phonetic {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .mastery-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 16px;
        }

        .mastery-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
        }

        .mastery-dot.filled {
            background: var(--success);
        }

        .word-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }

        .action-btn.active {
            background: #fef2f2;
            color: var(--error);
        }

        /* Options */
        .options-grid {
            display: grid;
            gap: 12px;
        }

        .option-btn {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            background: var(--surface);
            font-size: 16px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .option-btn.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .option-btn.wrong {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .option-btn:disabled {
            cursor: not-allowed;
        }

        /* Back Button */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 16px;
        }

        .back-btn:hover {
            color: var(--primary);
        }

        /* Result Screen */
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .result-screen.active {
            display: block;
        }

        .result-emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .result-stats {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .result-btn {
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-md);
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .result-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Favorites Page */
        .favorites-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .favorite-item:last-child {
            border-bottom: none;
        }

        .favorite-word {
            font-size: 18px;
            font-weight: 600;
        }

        .favorite-meaning {
            font-size: 14px;
            color: var(--text-muted);
        }

        .remove-btn {
            padding: 8px 12px;
            border: none;
            background: #fef2f2;
            color: var(--error);
            border-radius: var(--radius-md);
            font-size: 12px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Mistakes Page */
        .mistakes-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .mistake-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .mistake-item:last-child {
            border-bottom: none;
        }

        .mistake-word {
            font-size: 18px;
            font-weight: 600;
        }

        .mistake-meaning {
            font-size: 14px;
            color: var(--text-muted);
        }

        .review-mistakes-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--radius-md);
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .review-mistakes-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .review-mistakes-btn.disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Stats Page */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 700;
            color: var(--text-main);
        }

        .streak-display {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .streak-number {
            font-size: 48px;
            font-weight: 800;
            color: var(--warning);
        }

        .streak-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Reset Button */
        .reset-btn {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--error);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--error);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .reset-btn:hover {
            background: #fef2f2;
        }

        /* ==================== 登录模态框 ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-container {
            background: rgba(255, 255, 255, 0.9);
            width: 90%;
            max-width: 400px;
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            /* Changed from --primary-color to --primary */
            margin-bottom: 10px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
        }

        .input-group input {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            /* Changed from --primary-color to --primary */
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-btn {
            background: var(--primary-gradient);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .auth-switch span {
            color: var(--primary);
            /* Changed from --primary-color to --primary */
            font-weight: 600;
            cursor: pointer;
            margin-left: 5px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        /* 用户按钮 */
        .user-nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-nav-btn:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--background);
            /* Changed from --light-bg to --background */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        #userStatus {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        /* 配置页面 */
        .config-section {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        /* New styles for nav bar */
        .main-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .nav-brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .sync-indicator {
            font-size: 12px;
            color: var(--primary);
            opacity: 0.7;
            margin-right: 10px;
            display: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }

        .sync-indicator.active {
            display: inline-block;
        }

        /* ==================== AI 助教样式 ==================== */
        .ai-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 250px);
            max-height: 800px;
        }

        .ai-tabs {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .ai-tab {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ai-content {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid #eee;
            overflow: hidden;
            position: relative;
        }

        /* 聊天流样式 */
        .ai-chat-history {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ai-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
        }

        .ai-user-message {
            align-self: flex-end;
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-bot-message {
            align-self: flex-start;
            background: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }

        /* 思维过程样式 - 与正式回答明显区分 */
        .thought-container {
            font-size: 13px;
            color: #64748b;
            background: rgba(248, 250, 252, 0.7);
            border-left: 3px solid #94a3b8;
            padding: 10px 14px;
            margin-bottom: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px dashed #cbd5e1;
        }

        .thought-container:hover {
            background: rgba(241, 245, 249, 0.9);
            border-color: #94a3b8;
        }

        /* 思考中的呼吸灯动画 */
        @keyframes thinking-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .thought-container.thinking .thought-header {
            animation: thinking-pulse 1.5s ease-in-out infinite;
        }

        .thought-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            user-select: none;
            color: #64748b;
            font-size: 13px;
        }

        .thought-header-text {
            font-style: italic;
        }

        /* 思考内容 - 明显区别于正式回答的样式 */
        .thought-content {
            margin-top: 10px;
            display: none;
            line-height: 1.6;
            color: #9ca3af;
            /* 更淡的灰色 */
            font-size: 11px;
            /* 更小的字号 */
            font-style: italic;
            /* 斜体 */
            font-family: 'Courier New', Consolas, monospace;
            /* 等宽字体制造差异 */
            border: 1px dashed #d1d5db;
            padding: 12px;
            white-space: pre-wrap;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            /* 灰色渐变背景 */
            border-radius: 8px;
            opacity: 0.85;
            /* 轻微透明 */
            letter-spacing: -0.3px;
            /* 字间距紧凑 */
        }

        .thought-container.expanded .thought-content {
            display: block;
        }

        .thought-icon {
            font-size: 10px;
            transition: transform 0.25s ease;
            color: #94a3b8;
        }

        .thought-container.expanded .thought-icon {
            transform: rotate(90deg);
        }

        /* 思考完成后的状态样式 */
        .thought-container.completed {
            border-left-color: #10b981;
        }

        .thought-container.completed .thought-header {
            color: #10b981;
        }

        /* 正式回答样式 - 与思考内容形成鲜明对比 */
        .ai-answer {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            /* 正常字体 */
            font-size: 15px;
            /* 正常大小 */
            font-style: normal;
            /* 非斜体 */
            color: #1f2937;
            /* 深色文字 */
            line-height: 1.7;
            padding: 8px 0;
            white-space: pre-wrap;
        }

        .ai-input-wrapper {
            display: flex;
            gap: 10px;
            background: #f8fafc;
            padding: 8px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .ai-input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 12px;
            font-size: 15px;
            outline: none;
        }

        .ai-send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .ai-send-btn:hover {
            transform: scale(1.05);
        }

        /* 串联记忆样式 */
        .ai-word-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            padding: 5px;
        }

        .selectable-word {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px;
            border-radius: 10px;
            font-size: 13px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .selectable-word.selected {
            background: #eff6ff;
            border-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .ai-action-footer {
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 结果解析 */
        .markdown-content {
            white-space: pre-wrap;
            font-family: inherit;
        }

        .markdown-content code {
            background: #fee2e2;
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <nav class="main-nav">
            <div class="nav-brand">雅思词汇 📘</div>
            <div id="userStatus">
                <span class="sync-indicator" id="syncIndicator">☁️ 同步中...</span>
                <button class="user-nav-btn" onclick="openAuthModal()">
                    <div class="user-avatar" id="navAvatar">👤</div>
                    <span id="navUserName">登录 / 注册</span>
                </button>
            </div>
        </nav>
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchPage('learn')">
                <span>📚</span> 学习
            </button>
            <button class="nav-tab" onclick="switchPage('mistakes')">
                <span>❌</span> 错题
            </button>
            <button class="nav-tab" onclick="switchPage('favorites')">
                <span>⭐</span> 收藏
            </button>
            <button class="nav-tab" onclick="switchPage('stats')">
                <span>📊</span> 统计
            </button>
            <button class="nav-tab" onclick="switchPage('ai')">
                <span>🤖</span> AI
            </button>
        </div>

        <!-- Learn Page -->
        <div id="learnPage" class="page active">
            <!-- Task Selector -->
            <div id="taskSelector">
                <div class="task-cards">
                    <div class="task-card review" id="reviewCard" onclick="startMode('review')">
                        <div class="task-icon">📖</div>
                        <div class="task-title">复习单词</div>
                        <div class="task-count" id="reviewCount">0</div>
                        <div class="task-label">待复习</div>
                    </div>
                    <div class="task-card learn" id="learnCard" onclick="startMode('learn')">
                        <div class="task-icon">✨</div>
                        <div class="task-title">学新词</div>
                        <div class="task-count" id="newWordsCount">0</div>
                        <div class="task-label">新单词</div>
                    </div>
                </div>

                <!-- Category Selector -->
                <div class="category-section">
                    <div class="category-label">选择学习分类</div>
                    <select class="category-selector" id="categorySelector" onchange="updateCategoryInfo()">
                        <option value="all">📚 全部单词</option>
                        <optgroup label="话题词汇">
                            <option value="people">👥 人物关系</option>
                            <option value="health">💪 健康健身</option>
                            <option value="science">🔬 科学研究</option>
                            <option value="community">🏘️ 社区社会</option>
                            <option value="study">📖 学习教育</option>
                            <option value="advertising">📢 广告营销</option>
                            <option value="travel">✈️ 旅行地点</option>
                            <option value="government">🏛️ 政府政策</option>
                            <option value="animals">🐾 动物保护</option>
                            <option value="space">🚀 太空探索</option>
                            <option value="technology">💻 科技计算机</option>
                            <option value="machines">⚙️ 机器制造</option>
                            <option value="fashion">👗 时尚服饰</option>
                            <option value="city">🏙️ 城市生活</option>
                            <option value="environment">🌍 环境生态</option>
                            <option value="energy">⚡ 能源资源</option>
                            <option value="issues">📰 社会议题</option>
                            <option value="business">💼 商业职业</option>
                            <option value="crime">⚖️ 犯罪法律</option>
                            <option value="media">📺 媒体传播</option>
                            <option value="art">🎨 艺术文化</option>
                            <option value="changes">🔄 变化趋势</option>
                            <option value="data">📊 数据描述</option>
                            <option value="essay">✍️ 写作功能词</option>
                        </optgroup>
                        <optgroup label="听力高频">
                            <option value="listening">📝 听力常用/形容词</option>
                            <option value="countries">🌐 国家</option>
                            <option value="health_foods">🥗 健康食品</option>
                            <option value="homes">🏠 住房</option>
                            <option value="languages">🗣️ 语言</option>
                            <option value="marketing">📈 市场营销</option>
                            <option value="materials">🧱 材料</option>
                            <option value="occupations">👨‍💼 职业</option>
                            <option value="nature">🏔️ 自然</option>
                            <option value="places">📍 地点</option>
                            <option value="shapes">🔷 形状</option>
                            <option value="subjects">📚 学科</option>
                            <option value="touring">🎒 旅游</option>
                            <option value="transportation">🚂 交通运输</option>
                            <option value="vehicles">🚗 车辆</option>
                            <option value="weather">🌤️ 天气</option>
                            <option value="sports">⚽ 运动</option>
                            <option value="hobbies">🎯 爱好</option>
                        </optgroup>
                        <optgroup label="通用高频">
                            <option value="general">📖 通用高频词</option>
                        </optgroup>
                    </select>
                    <div class="category-info">
                        该分类有 <span class="category-count" id="categoryWordCount">0</span> 个新词可学习
                    </div>
                </div>

                <!-- Today Stats -->
                <div class="card">
                    <div class="card-title">今日概览</div>
                    <div class="today-stats">
                        <div class="today-stat">
                            <div class="today-label">已学习</div>
                            <div class="today-value" id="todayLearnedCount">0</div>
                        </div>
                        <div class="today-stat">
                            <div class="today-label">已复习</div>
                            <div class="today-value" id="todayReviewedCount">0</div>
                        </div>
                        <div class="today-stat">
                            <div class="today-label">正确率</div>
                            <div class="today-value" id="todayAccuracy">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning Container -->
            <div class="learning-container" id="learningContainer">
                <button class="back-btn" onclick="backToTaskSelector()">
                    ← 返回
                </button>

                <span class="mode-badge" id="modeBadge">📗 学新词</span>

                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0/0</div>

                <!-- Word Card -->
                <div class="word-card">
                    <div class="word-text" id="wordText">Word</div>
                    <div class="word-phonetic" id="wordPhonetic">/phonetic/</div>
                    <div class="mastery-dots" id="masteryDots">
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                        <div class="mastery-dot"></div>
                    </div>
                    <div class="word-actions">
                        <button class="action-btn" id="favoriteBtn" onclick="toggleFavorite()">
                            <span class="icon">🤍</span>
                        </button>
                        <button class="action-btn" onclick="askAIDetails()" title="问 AI">
                            <span class="icon">🤖</span>
                        </button>
                    </div>
                </div>

                <!-- Options -->
                <div class="options-grid" id="optionsGrid">
                    <button class="option-btn">选项1</button>
                    <button class="option-btn">选项2</button>
                    <button class="option-btn">选项3</button>
                    <button class="option-btn">选项4</button>
                </div>
            </div>

            <!-- Result Screen -->
            <div class="result-screen" id="resultScreen">
                <div class="result-emoji" id="resultEmoji">🎉</div>
                <div class="result-title" id="resultTitle">太棒了！</div>
                <div class="result-stats" id="resultStats"></div>
                <button class="result-btn" onclick="backToTaskSelector()">继续学习</button>
            </div>
        </div>

        <!-- Mistakes Page -->
        <div id="mistakesPage" class="page">
            <div class="card">
                <div class="card-title" style="margin-bottom: 20px;">错题本 ❌</div>
                <button class="review-mistakes-btn" id="reviewMistakesBtn" onclick="reviewMistakes()">
                    <span>🚀</span> 错题专项巩固
                </button>
                <div id="mistakesList" class="mistakes-list">
                    <!-- Mistakes list will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Favorites Page -->
        <div id="favoritesPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">我的收藏</div>
                    <button class="action-btn" onclick="reviewFavorites()" title="复习收藏">
                        📖
                    </button>
                </div>
                <div class="favorites-list" id="favoritesList">
                    <div class="empty-state">
                        <div class="empty-icon">⭐</div>
                        <p>还没有收藏的单词</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Page -->
        <div id="statsPage" class="page">
            <div class="streak-display">
                <div class="streak-number" id="streakNumber">0</div>
                <div class="streak-label">连续学习天数 🔥</div>
            </div>

            <div class="card">
                <div class="card-title">学习统计</div>
                <div class="stat-row">
                    <span class="stat-label">总词汇量</span>
                    <span class="stat-value" id="totalWords">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">已掌握</span>
                    <span class="stat-value" id="masteredWords">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">学习中</span>
                    <span class="stat-value" id="learningWords">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">待学习</span>
                    <span class="stat-value" id="newWords">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">总正确率</span>
                    <span class="stat-value" id="overallAccuracy">0%</span>
                </div>
            </div>



            <button class="reset-btn" onclick="resetProgress()">重置所有进度</button>
        </div>

        <!-- AI Assistant Page -->
        <div id="aiPage" class="page">
            <div class="ai-container">
                <div class="ai-tabs">
                    <button class="ai-tab active" id="tabChat" onclick="switchAITab('chat')">互动答疑</button>
                    <button class="ai-tab" id="tabArticle" onclick="switchAITab('article')">串联记忆</button>
                </div>

                <!-- Chat Mode -->
                <div id="aiChatMode" class="ai-content">
                    <div class="ai-chat-history" id="aiChatHistory">
                        <div class="ai-message ai-bot-message">
                            你好！我是你的雅思 AI 助教。你可以问我关于词汇辨析、语法用法、或者如何准备雅思的问题。👋
                        </div>
                    </div>
                    <div class="ai-input-wrapper">
                        <input type="text" id="aiChatInput" placeholder="输入你的问题..."
                            onkeyup="if(event.key==='Enter') sendAIChat()">
                        <button class="ai-send-btn" onclick="sendAIChat()">🚀</button>
                    </div>
                </div>

                <!-- Article Mode -->
                <div id="aiArticleMode" class="ai-content" style="display: none;">
                    <div class="ai-word-selector" id="articleSelectorArea">
                        <div class="card-title">选择 3-8 个单词生成短文</div>
                        <div class="word-grid" id="aiWordGrid">
                            <!-- Words will be loaded here from favorites/mistakes -->
                        </div>
                        <div class="ai-action-footer">
                            <div style="font-size: 12px; color: #666;">
                                已选择 <span id="selectedAICount">0</span> 个词
                            </div>
                            <button class="auth-btn" style="margin: 0;" onclick="generateStory()"
                                id="genStoryBtn">生成雅思短文</button>
                        </div>
                    </div>
                    <!-- Story Result Area -->
                    <div id="storyResultArea" style="display: none; height: 100%; flex-direction: column;">
                        <div class="ai-chat-history" style="flex: 1;">
                            <div class="ai-message ai-bot-message markdown-content" id="storyOutput">
                                正在思考并撰写中...
                            </div>
                        </div>
                        <button class="auth-btn" style="margin-top: 10px;" onclick="backToSelection()">重新选择</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-container">
            <span class="close-modal" onclick="closeAuthModal()">&times;</span>
            <div id="loginForm">
                <div class="modal-header">
                    <div class="modal-title">欢迎回来 👋</div>
                    <p>请登录以同步你的学习进度</p>
                </div>
                <div class="auth-form">
                    <div class="input-group">
                        <label>邮箱</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label>密码</label>
                        <input type="password" id="loginPassword" placeholder="••••••••">
                    </div>
                    <button class="auth-btn" onclick="handleSignIn()">登录</button>
                    <div class="auth-switch">
                        没有账号？ <span onclick="switchAuthMode('register')">开始注册</span>
                    </div>
                </div>
            </div>
            <div id="registerForm" style="display: none;">
                <div class="modal-header">
                    <div class="modal-title">创建账号 ✨</div>
                    <p>开启你的雅思提分之旅</p>
                </div>
                <div class="auth-form">
                    <div class="input-group">
                        <label>用户名</label>
                        <input type="text" id="regName" placeholder="你的昵称">
                    </div>
                    <div class="input-group">
                        <label>邮箱</label>
                        <input type="email" id="regEmail" placeholder="your@email.com">
                    </div>
                    <div class="input-group">
                        <label>密码</label>
                        <input type="password" id="regPassword" placeholder="至少 6 位密码">
                    </div>
                    <button class="auth-btn" onclick="handleSignUp()">注册账号</button>
                    <div class="auth-switch">
                        已有账号？ <span onclick="switchAuthMode('login')">立即登录</span>
                    </div>
                </div>
            </div>
            <div id="userInfoPanel" style="display: none;">
                <div class="modal-header" style="text-align: center;">
                    <div class="user-avatar" style="width: 64px; height: 64px; font-size: 32px; margin: 0 auto 15px;">👤
                    </div>
                    <div class="modal-title" id="panelUserName">用户名</div>
                    <p id="panelUserEmail">user@example.com</p>
                </div>
                <button class="auth-btn" style="background: #ef4444; width: 100%;"
                    onclick="handleSignOut()">退出登录</button>
            </div>
        </div>
    </div>

    <!-- 引入外部词库 (分部加载) -->
    <script src="vocabulary_part1.js"></script>
    <script src="vocabulary_part2.js"></script>
    <script src="vocabulary_part3.js"></script>
    <script src="vocabulary_part4.js"></script>
    <script src="vocabulary_part5.js"></script>
    <script src="vocabulary_part6.js"></script>
    <script src="vocabulary_part7.js"></script>
    <script src="vocabulary_part8.js"></script>
    <script src="vocabulary_part9.js"></script>
    <script src="vocabulary_part10.js"></script>
    <script src="vocabulary_part11.js"></script>
    <script src="vocabulary_part12.js"></script>
    <script src="vocabulary_part13.js"></script>
    <script src="vocabulary_part14.js"></script>
    <script src="vocabulary_part15.js"></script>
    <script src="vocabulary_part16.js"></script>
    <script src="vocabulary_part17.js"></script>
    <script src="vocabulary_part18.js"></script>
    <script src="vocabulary_part19.js"></script>
    <script src="vocabulary_part20.js"></script>
    <script src="vocabulary_part21.js"></script>
    <script src="vocabulary_part22.js"></script>
    <script src="vocabulary_part23.js"></script>
    <script src="vocabulary_part24.js"></script>
    <script src="vocabulary_part25.js"></script>
    <script src="vocabulary_part26.js"></script>
    <script src="vocabulary_part27.js"></script>
    <script src="vocabulary_part28.js"></script>
    <script src="vocabulary_part29.js"></script>
    <script src="vocabulary_part30.js"></script>
    <script src="vocabulary.js"></script>
    <script src="vendor/supabase-js-2.min.js"></script>

    <script>
        // ==================== 存储键 ====================
        const STORAGE_KEYS = {
            favorites: 'ielts_favorites',
            mistakes: 'ielts_mistakes',
            stats: 'ielts_stats',
            wordProgress: 'ielts_word_progress',
            lastStudyDate: 'ielts_last_study_date',
            streak: 'ielts_streak',
            supabaseConfig: 'ielts_supabase_config'
        };

        // ==================== Supabase 初始化 ====================
        let supabaseClient = null;
        let currentUser = null;

        function initSupabase() {
            // 发布模式：硬编码项目密钥
            const SUPABASE_URL = 'https://rbmdajxkdjnjnbhykcon.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_dFjOm81Y0tCFDA5WQd_HoA_LG8fc2Ip';

            try {
                // 使用全局 supabase 对象创建实例
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // 监听认证状态
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    updateUserUI();
                    if (currentUser && (event === 'SIGNED_IN' || event === 'INITIAL_SESSION')) {
                        pullUserData();
                    }
                });
            } catch (e) {
                console.error('Supabase init failed:', e);
            }
        }

        // ==================== 云端同步逻辑 ====================
        let syncTimer = null;

        async function pushUserData() {
            if (!supabaseClient || !currentUser) return;

            if (syncTimer) clearTimeout(syncTimer);

            const indicator = document.getElementById('syncIndicator');
            if (indicator) indicator.classList.add('active');

            syncTimer = setTimeout(async () => {
                const data = {
                    favorites,
                    mistakes,
                    stats,
                    word_progress: wordProgress,
                    streak,
                    updated_at: new Date()
                };

                const { error } = await supabaseClient
                    .from('user_data')
                    .upsert({ user_id: currentUser.id, ...data });

                if (error) console.error('Cloud sync push failed:', error);
                if (indicator) indicator.classList.remove('active');
            }, 2000);
        }

        async function pullUserData() {
            if (!supabaseClient || !currentUser) return;

            const { data, error } = await supabaseClient
                .from('user_data')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (error) {
                if (error.code === 'PGRST116') pushUserData();
                else console.error('Cloud sync pull failed:', error);
                return;
            }

            if (data) {
                favorites = data.favorites || [];
                mistakes = data.mistakes || [];
                stats = data.stats || { dailyStats: {}, totalCorrect: 0, totalAnswered: 0 };
                wordProgress = data.word_progress || {};
                streak = data.streak || 0;

                saveData(STORAGE_KEYS.favorites, favorites);
                saveData(STORAGE_KEYS.mistakes, mistakes);
                saveData(STORAGE_KEYS.stats, stats);
                saveData(STORAGE_KEYS.wordProgress, wordProgress);
                saveData(STORAGE_KEYS.streak, streak);

                updateTaskSelector();
                updateCategoryInfo();
            }
        }



        // ==================== SRS 间隔配置（分钟） ====================
        const SRS_INTERVALS = {
            0: 0,           // 未学习 -> 立即
            1: 10,          // 刚学会 -> 10分钟
            2: 60 * 24,     // 初步掌握 -> 1天
            3: 60 * 24 * 3, // 基本掌握 -> 3天
            4: 60 * 24 * 7, // 熟练 -> 7天
            5: 60 * 24 * 15 // 已掌握 -> 15天
        };

        // ==================== 分类名称映射 ====================
        const CATEGORY_NAMES = {
            'all': '📚 全部单词',
            'people': '👥 人物关系',
            'health': '💪 健康健身',
            'science': '🔬 科学研究',
            'community': '🏘️ 社区社会',
            'study': '📖 学习教育',
            'advertising': '📢 广告营销',
            'travel': '✈️ 旅行地点',
            'government': '🏛️ 政府政策',
            'animals': '🐾 动物保护',
            'space': '🚀 太空探索',
            'technology': '💻 科技计算机',
            'machines': '⚙️ 机器制造',
            'fashion': '👗 时尚服饰',
            'city': '🏙️ 城市生活',
            'environment': '🌍 环境生态',
            'energy': '⚡ 能源资源',
            'issues': '📰 社会议题',
            'business': '💼 商业职业',
            'crime': '⚖️ 犯罪法律',
            'media': '📺 媒体传播',
            'art': '🎨 艺术文化',
            'changes': '🔄 变化趋势',
            'data': '📊 数据描述',
            'essay': '✍️ 写作功能词',
            'listening': '📝 听力常见/形容词',
            'countries': '🌐 国家',
            'health_foods': '🥗 健康食品',
            'homes': '🏠 住房',
            'languages': '🗣️ 语言',
            'marketing': '📈 市场营销',
            'materials': '🧱 材料',
            'occupations': '👨‍💼 职业',
            'nature': '🏔️ 自然',
            'places': '📍 地点',
            'shapes': '🔷 形状',
            'subjects': '📚 学科',
            'touring': '🎒 旅游',
            'transportation': '🚂 交通运输',
            'vehicles': '🚗 车辆',
            'weather': '🌤️ 天气',
            'sports': '⚽ 运动',
            'hobbies': '🎯 爱好',
            'general': '📖 通用核心词'
        };

        // ==================== 状态变量 ====================
        let currentCategory = 'all';
        let favorites = [];
        let mistakes = [];
        let wordProgress = {};
        let stats = { dailyStats: {}, totalCorrect: 0, totalAnswered: 0 };
        let currentQueue = [];
        let currentIndex = 0;
        let currentMode = 'learn';
        let correctCount = 0;
        let masteryUpCount = 0;
        let streak = 0;

        // ==================== 工具函数 ====================
        function isStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function loadData(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        }

        function saveData(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        function getTodayStr() {
            return new Date().toISOString().split('T')[0];
        }

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // ==================== 进度管理 ====================
        function getWordProgress(word) {
            return wordProgress[word] || {
                mastery: 0,
                lastSeenAt: null,
                nextReviewAt: null,
                correctCount: 0,
                wrongCount: 0
            };
        }

        function calculateNextReview(mastery) {
            const intervalMinutes = SRS_INTERVALS[Math.min(mastery, 5)];
            return Date.now() + intervalMinutes * 60 * 1000;
        }

        function updateWordProgress(word, isCorrect) {
            const progress = getWordProgress(word);
            const oldMastery = progress.mastery;

            if (isCorrect) {
                progress.mastery = Math.min(progress.mastery + 1, 5);
                progress.correctCount++;
            } else {
                progress.mastery = Math.max(progress.mastery - 1, 0);
                progress.wrongCount++;
            }

            progress.lastSeenAt = Date.now();
            progress.nextReviewAt = calculateNextReview(progress.mastery);

            wordProgress[word] = progress;
            saveData(STORAGE_KEYS.wordProgress, wordProgress);
            pushUserData(); // 同步到云端

            return progress.mastery > oldMastery;
        }

        // ==================== 队列生成 ====================
        function getReviewQueue() {
            const now = Date.now();
            return vocabulary.filter(v => {
                const progress = getWordProgress(v.word);
                return progress.mastery > 0 && progress.nextReviewAt <= now;
            });
        }

        function getNewWordsQueue(category = null) {
            const targetCategory = category || currentCategory;
            return vocabulary.filter(v => {
                const progress = getWordProgress(v.word);
                if (progress.mastery !== 0) return false;
                if (targetCategory === 'all') return true;
                return v.category === targetCategory;
            });
        }

        function getTodayStats() {
            const today = getTodayStr();
            return stats.dailyStats[today] || { learned: 0, reviewed: 0, correct: 0, total: 0 };
        }

        // ==================== UI 更新 ====================
        function updateCategoryInfo() {
            currentCategory = document.getElementById('categorySelector').value;
            const categoryQueue = getNewWordsQueue(currentCategory);
            document.getElementById('categoryWordCount').textContent = categoryQueue.length;
            document.getElementById('newWordsCount').textContent = categoryQueue.length;

            const learnCard = document.getElementById('learnCard');
            if (categoryQueue.length === 0) {
                learnCard.classList.add('disabled');
                learnCard.onclick = null;
            } else {
                learnCard.classList.remove('disabled');
                learnCard.onclick = () => startMode('learn');
            }
        }

        function updateTaskSelector() {
            const reviewQueue = getReviewQueue();
            const newWordsQueue = getNewWordsQueue();
            const todayStats = getTodayStats();

            document.getElementById('reviewCount').textContent = reviewQueue.length;
            document.getElementById('newWordsCount').textContent = newWordsQueue.length;
            document.getElementById('categoryWordCount').textContent = newWordsQueue.length;

            document.getElementById('todayLearnedCount').textContent = todayStats.learned || 0;
            document.getElementById('todayReviewedCount').textContent = todayStats.reviewed || 0;

            const accuracy = todayStats.total > 0
                ? Math.round((todayStats.correct / todayStats.total) * 100) + '%'
                : '0%';
            document.getElementById('todayAccuracy').textContent = accuracy;

            const reviewCard = document.getElementById('reviewCard');
            const learnCard = document.getElementById('learnCard');

            if (reviewQueue.length === 0) {
                reviewCard.classList.add('disabled');
                reviewCard.onclick = null;
            } else {
                reviewCard.classList.remove('disabled');
                reviewCard.onclick = () => startMode('review');
            }

            if (newWordsQueue.length === 0) {
                learnCard.classList.add('disabled');
                learnCard.onclick = null;
            } else {
                learnCard.classList.remove('disabled');
                learnCard.onclick = () => startMode('learn');
            }
        }

        function renderMasteryDots(mastery) {
            const container = document.getElementById('masteryDots');
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dot = document.createElement('div');
                dot.className = 'mastery-dot' + (i < mastery ? ' filled' : '');
                container.appendChild(dot);
            }
        }

        function updateProgress() {
            const total = currentQueue.length;
            const progress = total > 0 ? (currentIndex / total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${currentIndex + 1}/${total}`;
        }

        function updateFavoriteButton() {
            if (currentQueue.length === 0) return;
            const current = currentQueue[currentIndex];
            const isFav = favorites.includes(current.word);
            const btn = document.getElementById('favoriteBtn');
            btn.innerHTML = isFav ? '<span class="icon">❤️</span>' : '<span class="icon">🤍</span>';
            btn.classList.toggle('active', isFav);
        }

        // ==================== 学习模式控制 ====================
        function startMode(mode) {
            currentMode = mode;
            currentIndex = 0;
            correctCount = 0;
            masteryUpCount = 0;

            if (mode === 'review') {
                currentQueue = shuffleArray(getReviewQueue());
                document.getElementById('modeBadge').textContent = '📖 复习模式';
                document.getElementById('modeBadge').classList.remove('learn-mode');
            } else {
                currentQueue = shuffleArray(getNewWordsQueue());
                const categoryName = CATEGORY_NAMES[currentCategory] || '📗 学新词';
                document.getElementById('modeBadge').textContent = categoryName;
                document.getElementById('modeBadge').classList.add('learn-mode');
            }

            if (currentQueue.length === 0) {
                alert('没有可用的单词！');
                return;
            }

            document.getElementById('taskSelector').style.display = 'none';
            document.getElementById('learningContainer').classList.add('active');
            document.getElementById('resultScreen').classList.remove('active');

            showCurrentWord();
        }

        function showCurrentWord() {
            if (currentIndex >= currentQueue.length) {
                showResult();
                return;
            }

            const current = currentQueue[currentIndex];
            const progress = getWordProgress(current.word);

            document.getElementById('wordText').textContent = current.word;
            document.getElementById('wordPhonetic').textContent = current.phonetic;

            renderMasteryDots(progress.mastery);
            updateProgress();
            updateFavoriteButton();

            // 生成选项
            const options = [current.meaning, ...current.distractors];
            const shuffledOptions = shuffleArray(options);

            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = '';

            shuffledOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectOption(btn, option, current.meaning);
                optionsGrid.appendChild(btn);
            });
        }

        function selectOption(btn, selected, correct) {
            const isCorrect = selected === correct;
            const current = currentQueue[currentIndex];

            // 更新统计
            const today = getTodayStr();
            if (!stats.dailyStats[today]) {
                stats.dailyStats[today] = { learned: 0, reviewed: 0, correct: 0, total: 0 };
            }
            stats.dailyStats[today].total++;
            stats.totalAnswered++;

            if (isCorrect) {
                btn.classList.add('correct');
                correctCount++;
                stats.dailyStats[today].correct++;
                stats.totalCorrect++;
            } else {
                btn.classList.add('wrong');
                // 显示正确答案
                document.querySelectorAll('.option-btn').forEach(b => {
                    if (b.textContent === correct) {
                        b.classList.add('correct');
                    }
                });
                // 添加到错题本
                if (!mistakes.includes(current.word)) {
                    mistakes.push(current.word);
                    saveData(STORAGE_KEYS.mistakes, mistakes);
                    pushUserData(); // 同步到云端
                }
            }

            // 更新进度
            if (currentMode === 'learn') {
                stats.dailyStats[today].learned++;
            } else {
                stats.dailyStats[today].reviewed++;
            }

            const masteryUp = updateWordProgress(current.word, isCorrect);
            if (masteryUp) masteryUpCount++;

            saveData(STORAGE_KEYS.stats, stats);
            pushUserData(); // 同步到云端

            // Disable all options
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            // 延迟后进入下一题
            setTimeout(() => {
                currentIndex++;
                showCurrentWord();
            }, isCorrect ? 800 : 1500);
        }

        function showResult() {
            document.getElementById('learningContainer').classList.remove('active');
            document.getElementById('resultScreen').classList.add('active');

            const total = currentQueue.length;
            const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;

            let emoji, title;
            if (accuracy >= 90) { emoji = '🏆'; title = '太棒了！'; }
            else if (accuracy >= 70) { emoji = '🎉'; title = '做得不错！'; }
            else if (accuracy >= 50) { emoji = '💪'; title = '继续加油！'; }
            else { emoji = '📚'; title = '再接再厉！'; }

            document.getElementById('resultEmoji').textContent = emoji;
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultStats').innerHTML = `
                ${currentMode === 'review' ? '复习' : '学习'}了 <strong>${total}</strong> 个单词<br>
                正确率: <strong>${accuracy}%</strong><br>
                掌握度提升: <strong>${masteryUpCount}</strong> 个
            `;

            updateStreak();
        }

        function backToTaskSelector() {
            document.getElementById('taskSelector').style.display = 'block';
            document.getElementById('learningContainer').classList.remove('active');
            document.getElementById('resultScreen').classList.remove('active');
            updateTaskSelector();
        }

        // ==================== 收藏功能 ====================
        function toggleFavorite() {
            if (currentQueue.length === 0) return;
            const current = currentQueue[currentIndex];
            const index = favorites.indexOf(current.word);

            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(current.word);
            }

            saveData(STORAGE_KEYS.favorites, favorites);
            pushUserData(); // 同步到云端
            updateFavoriteButton();
        }

        function updateFavoritesList() {
            const container = document.getElementById('favoritesList');

            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⭐</div>
                        <p>还没有收藏的单词</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            favorites.forEach(word => {
                const wordData = vocabulary.find(v => v.word === word);
                if (!wordData) return;

                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.innerHTML = `
                    <div>
                        <div class="favorite-word">${wordData.word}</div>
                        <div class="favorite-meaning">${wordData.meaning}</div>
                    </div>
                    <button class="remove-btn" onclick="removeFavorite('${word}')">移除</button>
                `;
                container.appendChild(item);
            });
        }

        function removeFavorite(word) {
            const index = favorites.indexOf(word);
            if (index > -1) {
                favorites.splice(index, 1);
                saveData(STORAGE_KEYS.favorites, favorites);
                pushUserData(); // 同步到云端
                updateFavoritesList();
            }
        }

        function reviewFavorites() {
            if (favorites.length === 0) {
                alert('还没有收藏的单词！');
                return;
            }

            currentQueue = shuffleArray(
                favorites.map(word => vocabulary.find(v => v.word === word)).filter(Boolean)
            );
            currentMode = 'review';
            currentIndex = 0;
            correctCount = 0;
            masteryUpCount = 0;

            document.getElementById('modeBadge').textContent = '⭐ 收藏复习';
            document.getElementById('modeBadge').classList.remove('learn-mode');

            switchPage('learn');
            document.getElementById('taskSelector').style.display = 'none';
            document.getElementById('learningContainer').classList.add('active');

            showCurrentWord();
        }

        // ==================== 错题功能 ====================
        function updateMistakesList() {
            const container = document.getElementById('mistakesList');
            const reviewBtn = document.getElementById('reviewMistakesBtn');

            if (mistakes.length === 0) {
                reviewBtn.classList.add('disabled');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">❌</div>
                        <p>还没有错题记录</p>
                    </div>
                `;
                return;
            }

            reviewBtn.classList.remove('disabled');
            container.innerHTML = '';
            mistakes.forEach(word => {
                const wordData = vocabulary.find(v => v.word === word);
                if (!wordData) return;

                const item = document.createElement('div');
                item.className = 'mistake-item';
                item.innerHTML = `
                    <div>
                        <div class="mistake-word">${wordData.word}</div>
                        <div class="mistake-meaning">${wordData.meaning}</div>
                    </div>
                    <button class="remove-btn" onclick="removeMistake('${word}')">移除</button>
                `;
                container.appendChild(item);
            });
        }

        function removeMistake(word) {
            const index = mistakes.indexOf(word);
            if (index > -1) {
                mistakes.splice(index, 1);
                saveData(STORAGE_KEYS.mistakes, mistakes);
                pushUserData(); // 同步到云端
                updateMistakesList();
            }
        }

        function reviewMistakes() {
            if (mistakes.length === 0) return;

            currentQueue = shuffleArray(
                mistakes.map(word => vocabulary.find(v => v.word === word)).filter(Boolean)
            );
            currentMode = 'review';
            currentIndex = 0;
            correctCount = 0;
            masteryUpCount = 0;

            document.getElementById('modeBadge').textContent = '❌ 错题巩固';
            document.getElementById('modeBadge').classList.remove('learn-mode');

            switchPage('learn');
            document.getElementById('taskSelector').style.display = 'none';
            document.getElementById('learningContainer').classList.add('active');

            showCurrentWord();

        }

        // ==================== 统计页面 ====================
        function updateStatsPage() {
            const total = vocabulary.length;
            let mastered = 0, learning = 0, newCount = 0;

            vocabulary.forEach(v => {
                const progress = getWordProgress(v.word);
                if (progress.mastery >= 4) mastered++;
                else if (progress.mastery > 0) learning++;
                else newCount++;
            });

            document.getElementById('totalWords').textContent = total;
            document.getElementById('masteredWords').textContent = mastered;
            document.getElementById('learningWords').textContent = learning;
            document.getElementById('newWords').textContent = newCount;

            const overallAccuracy = stats.totalAnswered > 0
                ? Math.min(100, Math.round((stats.totalCorrect / stats.totalAnswered) * 100)) + '%'
                : '0%';
            document.getElementById('overallAccuracy').textContent = overallAccuracy;

            document.getElementById('streakNumber').textContent = streak;
        }

        function updateStreak() {
            const today = getTodayStr();
            const lastDate = loadData(STORAGE_KEYS.lastStudyDate);

            if (lastDate === today) return;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (lastDate === yesterdayStr) {
                streak++;
            } else if (lastDate !== today) {
                streak = 1;
            }

            saveData(STORAGE_KEYS.lastStudyDate, today);
            saveData(STORAGE_KEYS.streak, streak);
        }

        function resetProgress() {
            if (!confirm('确定要重置所有学习进度吗？此操作不可恢复！')) return;

            localStorage.removeItem(STORAGE_KEYS.wordProgress);
            localStorage.removeItem(STORAGE_KEYS.stats);
            localStorage.removeItem(STORAGE_KEYS.lastStudyDate);
            localStorage.removeItem(STORAGE_KEYS.streak);
            localStorage.removeItem(STORAGE_KEYS.mistakes);

            wordProgress = {};
            stats = { dailyStats: {}, totalCorrect: 0, totalAnswered: 0 };
            streak = 0;
            mistakes = [];

            updateTaskSelector();
            updateStatsPage();
            alert('学习进度已重置！');
        }


        // ==================== 认证交互逻辑 ====================
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
            updateUserUI();
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function switchAuthMode(mode) {
            document.getElementById('loginForm').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = mode === 'register' ? 'block' : 'none';
        }

        function updateUserUI() {
            const navUserName = document.getElementById('navUserName');
            const navAvatar = document.getElementById('navAvatar');
            const userInfoPanel = document.getElementById('userInfoPanel');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (currentUser) {
                const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
                navUserName.textContent = name;
                navAvatar.textContent = name.charAt(0).toUpperCase();

                document.getElementById('panelUserName').textContent = name;
                document.getElementById('panelUserEmail').textContent = currentUser.email;

                userInfoPanel.style.display = 'block';
                loginForm.style.display = 'none';
                registerForm.style.display = 'none';
            } else {
                navUserName.textContent = '登录 / 注册';
                navAvatar.textContent = '👤';

                userInfoPanel.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
        }

        async function handleSignUp() {
            if (!supabaseClient) return alert('请先配置 Supabase URL 和 Key');

            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const name = document.getElementById('regName').value.trim();

            if (!email || !password) return alert('请填写邮箱和密码');

            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: { full_name: name }
                }
            });

            if (error) alert('注册失败: ' + error.message);
            else alert('注册成功！请查收确认邮件。');
        }

        async function handleSignIn() {
            if (!supabaseClient) return alert('请先配置 Supabase URL 和 Key');

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) return alert('请填写邮箱和密码');

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) alert('登录失败: ' + error.message);
            else closeAuthModal();
        }

        async function handleSignOut() {
            if (!supabaseClient) return;
            const { error } = await supabaseClient.auth.signOut();
            if (error) alert('退出失败: ' + error.message);
            else {
                currentUser = null;
                updateUserUI();
                closeAuthModal();
            }
        }

        // ==================== 页面切换 ====================
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(pageName + 'Page').classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchPage('${pageName}')"]`).classList.add('active');

            if (pageName === 'favorites') {
                updateFavoritesList();
            } else if (pageName === 'mistakes') {
                updateMistakesList();
            } else if (pageName === 'stats') {
                updateStatsPage();
            } else if (pageName === 'learn') {
                backToTaskSelector();
            } else if (pageName === 'ai') {
                updateAIScreen();
            }
        }

        // ==================== AI 助教逻辑 ====================
        const SILICONFLOW_KEY = 'sk-ojeuemqkhurccbvzfklofluhraogjazswfhmjgwvvlzkhkyn';
        const AI_MODEL = 'deepseek-ai/DeepSeek-R1-Distill-Qwen-7B';
        let selectedAIWords = [];
        let aiHistory = [];

        function switchAITab(mode) {
            document.getElementById('aiChatMode').style.display = mode === 'chat' ? 'flex' : 'none';
            document.getElementById('aiArticleMode').style.display = mode === 'article' ? 'flex' : 'none';
            document.getElementById('tabChat').classList.toggle('active', mode === 'chat');
            document.getElementById('tabArticle').classList.toggle('active', mode === 'article');
            if (mode === 'article') updateAIWordGrid();
        }

        function updateAIScreen() {
            switchAITab('chat');
        }

        function updateAIWordGrid() {
            const grid = document.getElementById('aiWordGrid');
            grid.innerHTML = '';

            // 获取收藏和最近错题
            const candidateWords = [...new Set([...favorites, ...mistakes.slice(-20)])];

            if (candidateWords.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 20px;">先去学习或收藏一些单词吧</div>';
                return;
            }

            candidateWords.forEach(word => {
                const div = document.createElement('div');
                div.className = `selectable-word ${selectedAIWords.includes(word) ? 'selected' : ''}`;
                div.textContent = word;
                div.onclick = () => toggleAIWord(word, div);
                grid.appendChild(div);
            });
            updateSelectedCount();
        }

        function toggleAIWord(word, element) {
            const index = selectedAIWords.indexOf(word);
            if (index > -1) {
                selectedAIWords.splice(index, 1);
                element.classList.remove('selected');
            } else {
                if (selectedAIWords.length >= 8) return alert('最多选择 8 个单词');
                selectedAIWords.push(word);
                element.classList.add('selected');
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedAICount').textContent = selectedAIWords.length;
            document.getElementById('genStoryBtn').disabled = selectedAIWords.length < 3;
        }

        // 简易Markdown解析
        function parseMarkdown(text) {
            if (!text) return '';
            return text
                // 转义HTML特殊字符
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // 粗体 **text** 或 __text__
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.+?)__/g, '<strong>$1</strong>')
                // 斜体 *text* 或 _text_
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/_(.+?)_/g, '<em>$1</em>')
                // 代码 `code`
                .replace(/`(.+?)`/g, '<code style="background:#fee2e2;padding:2px 4px;border-radius:4px;">$1</code>')
                // 换行
                .replace(/\n/g, '<br>');
        }

        async function callAIStreaming(messages, onUpdate) {
            let fullContent = '';
            try {
                const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SILICONFLOW_KEY}`
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                const content = data.choices[0].delta.content || '';
                                fullContent += content;

                                if (fullContent) onUpdate(fullContent);
                            } catch (e) { }
                        }
                    }
                }
                return fullContent;
            } catch (e) {
                console.error('AI Stream failed:', e);
                onUpdate('抱歉，我现在遇到了一点网络问题，请稍后再试。');
                return '';
            }
        }

        async function sendAIChat() {
            const input = document.getElementById('aiChatInput');
            const text = input.value.trim();
            if (!text) return;

            const chatHistory = document.getElementById('aiChatHistory');

            // 用户消息
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-message ai-user-message';
            userMsg.textContent = text;
            chatHistory.appendChild(userMsg);
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // 等待回复
            const botMsg = document.createElement('div');
            botMsg.className = 'ai-message ai-bot-message';
            botMsg.textContent = '...';
            chatHistory.appendChild(botMsg);

            let thoughtContainer = null;
            let thoughtContent = null;
            let answerArea = null;
            let cachedThinkingPart = ''; // 缓存思考内容，完成后再显示

            const messages = [
                { role: 'system', content: '你是一位资深的雅思（IELTS）助教，拥有多年备考指导经验。请用专业、亲切且极具启发性的语言回答用户。你的回答应侧重于：雅思核心词汇的精准辨析、真题实战中的高位替换、地道的英式/美式口语/写作表达，以及实用的备考技巧。' },
                ...aiHistory.slice(-6),
                { role: 'user', content: text }
            ];

            const fullResponse = await callAIStreaming(messages, (full) => {
                let thinkingPart = '';
                let answerPart = '';

                // 解析思考过程和正式回答
                const thinkStart = full.indexOf('<think>');
                const thinkEnd = full.indexOf('</think>');

                if (thinkStart !== -1) {
                    if (thinkEnd !== -1) {
                        // 完整的思考过程
                        thinkingPart = full.substring(thinkStart + 7, thinkEnd);
                        answerPart = full.substring(thinkEnd + 8);
                    } else {
                        // 思考进行中（还没收到</think>）
                        thinkingPart = full.substring(thinkStart + 7);
                        answerPart = '';
                    }
                } else if (thinkEnd !== -1) {
                    // 处理流式分块：收到了</think>但开头在之前的块
                    answerPart = full.substring(thinkEnd + 8);
                } else {
                    // 没有think标签，全部是正式回答
                    answerPart = full;
                }

                // 清理可能残留的标签
                answerPart = answerPart.replace(/<\/?think>/g, '').trim();

                if (thinkingPart) {
                    cachedThinkingPart = thinkingPart.trim(); // 缓存思考内容
                    if (!thoughtContainer) {
                        botMsg.textContent = ''; // 清除 "..."
                        thoughtContainer = document.createElement('div');
                        thoughtContainer.className = 'thought-container thinking'; // 添加thinking类触发动画
                        thoughtContainer.innerHTML = `
                            <div class="thought-header" onclick="this.parentElement.classList.toggle('expanded')">
                                <span class="thought-icon">▶</span>
                                <span class="thought-header-text">🧠 正在思考...</span>
                            </div>
                            <div class="thought-content"></div>
                        `;
                        botMsg.appendChild(thoughtContainer);
                        thoughtContent = thoughtContainer.querySelector('.thought-content');
                    }
                    // 思考中：不实时更新内容，只保持"正在思考..."状态
                }

                // 思考完成，填入思考内容并更新状态
                if (full.includes('</think>') && thoughtContainer && thoughtContainer.classList.contains('thinking')) {
                    thoughtContainer.classList.remove('thinking');
                    thoughtContainer.classList.add('completed');
                    thoughtContainer.querySelector('.thought-header-text').textContent = '💭 查看思考过程';
                    thoughtContent.textContent = cachedThinkingPart;
                }

                if (answerPart.trim()) {
                    if (botMsg.textContent === '...') botMsg.textContent = ''; // 兜底清除
                    if (!answerArea) {
                        answerArea = document.createElement('div');
                        answerArea.className = 'ai-answer'; // 正式回答样式
                        botMsg.appendChild(answerArea);
                    }
                    answerArea.innerHTML = parseMarkdown(answerPart.trim());
                }
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });

            // 存入历史（去掉思考过程和标签）
            let savedContent = fullResponse;
            if (fullResponse.includes('</think>')) {
                savedContent = fullResponse.split('</think>')[1];
            }
            savedContent = savedContent.replace(/<\/?think>/g, '').trim();
            aiHistory.push({ role: 'user', content: text }, { role: 'assistant', content: savedContent });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function generateStory() {
            if (selectedAIWords.length < 3) return;

            const selectorArea = document.getElementById('articleSelectorArea');
            const resultArea = document.getElementById('storyResultArea');
            const output = document.getElementById('storyOutput');

            selectorArea.style.display = 'none';
            resultArea.style.display = 'flex';
            output.textContent = '...';

            const prompt = `你是一位雅思金牌讲师。请使用以下核心词汇编写一段自然流利、符合雅思阅读/写作难度（Band 7+）的英文短文（约 120-180 词）：${selectedAIWords.join(', ')}。
要求：
1. 语境必须自然，严禁为了堆砌词汇而生硬拼凑。
2. 必须包含指定的单词，并使用 **加粗** 格式突出显示。
3. 提供全文的中文参考翻译。
4. 【独家秘籍】：简要点评这几个词在雅思写作或口语中的高分用法（例如：是属于环境类还是教育类话题，有什么常见的搭配）。`;

            await callAIStreaming([{ role: 'user', content: prompt }], (full) => {
                let displayPart = full;
                if (full.includes('</think>')) {
                    displayPart = full.split('</think>')[1].trim();
                } else if (full.includes('<think>')) {
                    displayPart = '🤔 助教正在深度构思中...';
                }
                // 清理残留标签并解析Markdown
                displayPart = displayPart.replace(/<\/?think>/g, '');
                output.innerHTML = parseMarkdown(displayPart);
            });
        }

        function askAIDetails() {
            if (currentQueue.length === 0) return;
            const word = currentQueue[currentIndex].word;
            switchPage('ai');
            switchAITab('chat');
            const input = document.getElementById('aiChatInput');
            input.value = `我想深入了解 "${word}" 这个词的用法和辨析。`;
            sendAIChat();
        }

        function backToSelection() {
            document.getElementById('articleSelectorArea').style.display = 'flex';
            document.getElementById('storyResultArea').style.display = 'none';
        }

        // ==================== 初始化 ====================
        function init() {
            initSupabase();
            favorites = loadData(STORAGE_KEYS.favorites, []);
            mistakes = loadData(STORAGE_KEYS.mistakes, []);
            wordProgress = loadData(STORAGE_KEYS.wordProgress, {});
            stats = loadData(STORAGE_KEYS.stats, { dailyStats: {}, totalCorrect: 0, totalAnswered: 0 });
            streak = loadData(STORAGE_KEYS.streak, 0);

            // 数据自愈与平滑迁移
            if (!stats || typeof stats !== 'object') {
                stats = { dailyStats: {}, totalCorrect: 0, totalAnswered: 0 };
            }
            if (stats.totalAnswered === undefined || isNaN(stats.totalAnswered)) {
                stats.totalAnswered = stats.totalCorrect || 0;
            }
            if (stats.totalCorrect === undefined || isNaN(stats.totalCorrect)) {
                stats.totalCorrect = 0;
            }
            // 确保统计一致性：正确数不应超过总答题数
            if (stats.totalCorrect > stats.totalAnswered) {
                stats.totalAnswered = stats.totalCorrect;
            }

            updateTaskSelector();
            updateCategoryInfo();
        }

        // 启动
        if (!isStorageAvailable()) {
            alert('⚠️ 浏览器存储不可用！请检查隐私模式设置。');
        }

        init();
    </script>

    <!-- 注册 Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('✅ Service Worker 注册成功:', reg.scope))
                    .catch(err => console.log('❌ Service Worker 注册失败:', err));
            });
        }
    </script>
</body>

</html>
